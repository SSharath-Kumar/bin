#!/usr/bin/env bash

HELP=$(cat <<EOF
Usage: $(basename "$0") [TARGET_BRANCH]
Usage Example: $(basename "$0") my-branch

Arguments:
  TARGET_BRANCH  The branch to compare against for merged branches. Defaults to 'main'.

Options:
  -h, --help   Show this help message and exit.

Description:
  This script performs the following actions:
  1. Fetches the latest remote information and prunes deleted branches.
  2. Identifies local branches that are fully merged into the TARGET_BRANCH.
  3. Prompts the user to delete these merged branches.
  4. Identifies local branches that no longer have a remote.
  5. Prompts the user to delete these stale branches.
EOF
)
if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    echo "$HELP"
    exit 0
fi

# Cleans branches with respect to TARGET_BRANCH
TARGET_BRANCH=${1:-main} # Default to 'main' if none is specified.

# Verify the branch exists
if ! git show-ref --verify --quiet "refs/heads/$TARGET_BRANCH"; then
  echo "Error: Branch '$TARGET_BRANCH' does not exist."
  exit 1
fi

echo "Fetching latest remote info and pruning..."
git fetch --prune

# Identify local branches fully merged into the target branch.
MERGED_BRANCHES=$(git branch --merged "$TARGET_BRANCH" |
  grep -v "$TARGET_BRANCH" |
  grep -v "^\*" |
  sed 's/^  //')

if [ -z "$MERGED_BRANCHES" ]; then
  echo "No local branches merged into '$TARGET_BRANCH' found. Nothing to clean."
else
  echo "The following branches are fully merged into '$TARGET_BRANCH':"
  echo "$MERGED_BRANCHES"
  read -r -p "Do you want to delete these merged branches? [y/N]: " CONFIRM
  if [[ "$CONFIRM" =~ ^[Yy]$ ]]; then
    # Delete merged branches
    for BRANCH in $MERGED_BRANCHES; do
      git branch -d "$BRANCH"
    done
  else
    echo "Skipping deletion of merged branches."
  fi
fi

# Identify local branches that no longer have a remote.
STALE_BRANCHES=$(git branch -v | grep '\[gone\]' | awk '{print $1}')

if [ -z "$STALE_BRANCHES" ]; then
  echo "No stale branches (i.e., branches with no remote) found."
else
  echo "The following branches have no remote and might be stale:"
  echo "$STALE_BRANCHES"
  read -r -p "Do you want to delete these stale branches? [y/N]: " CONFIRM_STALE
  if [[ "$CONFIRM_STALE" =~ ^[Yy]$ ]]; then
    for BRANCH in $STALE_BRANCHES; do
      git branch -D "$BRANCH"
    done
  else
    echo "Skipping deletion of stale branches."
  fi
fi

echo "Done."
